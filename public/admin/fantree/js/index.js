

const dataSample = {
  "id": "@1",
  "order": 0,
  "name": "Person Name",
  "dob": "1900-01-01",
  "photo": undefined,
  "translateX": null,
  "translateY": null,
  "parents": [
    {
      "id": "@2",
      "order": 1,
      "name": "Parent 1",
      "dob": "1870-01-01",
      "photo": undefined,
      "translateX": null,
      "translateY": null,
      "parents": [
        {
          "id": "@3",
          "order": 1,
          "name": "Parent 11",
          "dob": "1870-01-01",
          "photo": undefined,
          "translateX": null,
          "translateY": null,
          "parents": [
            {
              "id": "@4",
              "order": 1,
              "name": "Parent 11",
              "dob": "1870-01-01",
              "photo": undefined,
              "translateX": null,
              "translateY": null,
              "parents": [
                {
                  "id": "@5",
                  "order": 1,
                  "name": "Parent 11",
                  "dob": "1870-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                },
                {
                  "id": "@6",
                  "order": 2,
                  "name": "Parent 12",
                  "dob": "1875-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                }
              ]
            },
            {
              "id": "@7",
              "order": 2,
              "name": "Parent 12",
              "dob": "1875-01-01",
              "photo": undefined,
              "translateX": null,
              "translateY": null,
              "parents": [
                {
                  "id": "@8",
                  "order": 1,
                  "name": "Parent 11",
                  "dob": "1870-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                },
                {
                  "id": "@9",
                  "order": 2,
                  "name": "Parent 12",
                  "dob": "1875-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                }
              ]
            }
          ]
        },
        {
          "id": "@10",
          "order": 2,
          "name": "Parent 12",
          "dob": "1875-01-01",
          "photo": undefined,
          "translateX": null,
          "translateY": null,
          "parents": [
            {
              "id": "@11",
              "order": 1,
              "name": "Parent 11",
              "dob": "1870-01-01",
              "photo": undefined,
              "translateX": null,
              "translateY": null,
              "parents": [
                {
                  "id": "@12",
                  "order": 1,
                  "name": "Parent 11",
                  "dob": "1870-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                },
                {
                  "id": "@13",
                  "order": 2,
                  "name": "Parent 12",
                  "dob": "1875-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                }
              ]
            },
            {
              "id": "@14",
              "order": 2,
              "name": "Parent 12",
              "dob": "1875-01-01",
              "photo": undefined,
              "translateX": null,
              "translateY": null,
              "parents": [
                {
                  "id": "@15",
                  "order": 1,
                  "name": "Parent 11",
                  "dob": "1870-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                },
                {
                  "id": "@16",
                  "order": 2,
                  "name": "Parent 12",
                  "dob": "1875-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "@17",
      "order": 2,
      "name": "Parent 2",
      "dob": "1875-01-01",
      "photo": undefined,
      "translateX": null,
      "translateY": null,
      "parents": [
        {
          "id": "@18",
          "order": 1,
          "name": "Parent 21",
          "dob": "1870-01-01",
          "photo": undefined,
          "translateX": null,
          "translateY": null,
          "parents": [
            {
              "id": "@19",
              "order": 1,
              "name": "Parent 11",
              "dob": "1870-01-01",
              "photo": undefined,
              "translateX": null,
              "translateY": null,
              "parents": [
                {
                  "id": "@20",
                  "order": 1,
                  "name": "Parent 11",
                  "dob": "1870-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                },
                {
                  "id": "@21",
                  "order": 2,
                  "name": "Parent 12",
                  "dob": "1875-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                }
              ]
            },
            {
              "id": "@22",
              "order": 2,
              "name": "Parent 12",
              "dob": "1875-01-01",
              "photo": undefined,
              "translateX": null,
              "translateY": null,
              "parents": [
                {
                  "id": "@23",
                  "order": 1,
                  "name": "Parent 11",
                  "dob": "1870-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                },
                {
                  "id": "@24",
                  "order": 2,
                  "name": "Parent 12",
                  "dob": "1875-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                }
              ]
            }
          ]
        },
        {
          "id": "@25",
          "order": 2,
          "name": "Parent 22",
          "dob": "1875-01-01",
          "photo": undefined,
          "translateX": null,
          "translateY": null,
          "parents": [
            {
              "id": "@26",
              "order": 1,
              "name": "Parent 11",
              "dob": "1870-01-01",
              "photo": undefined,
              "translateX": null,
              "translateY": null,
              "parents": [
                {
                  "id": "@27",
                  "order": 1,
                  "name": "Parent 11",
                  "dob": "1870-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                },
                {
                  "id": "@28",
                  "order": 2,
                  "name": "Parent 12",
                  "dob": "1875-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                }
              ]
            },
            {
              "id": "@29",
              "order": 2,
              "name": "Parent 12",
              "dob": "1875-01-01",
              "photo": undefined,
              "translateX": null,
              "translateY": null,
              "parents": [
                {
                  "id": "@30",
                  "order": 1,
                  "name": "Parent 11",
                  "dob": "1870-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                },
                {
                  "id": "@31",
                  "order": 2,
                  "name": "Parent 12",
                  "dob": "1875-01-01",
                  "photo": undefined,
                  "translateX": null,
                  "translateY": null,
                  "parents": [
                    // Grandparents
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}




function renderChart() {

  d3.select("div#graph").selectAll("*").remove();
  chart = undefined
  const data = familyData
  
  // select the main container to get width and height
  const mainGraphDiv = d3.select("div#main_graph");
  const spaceDepth = 220
  // Get the width and height of div#graph
  
  const width = parseInt(mainGraphDiv.style("width")) - 16;
  const height = parseInt(mainGraphDiv.style("height"));
  
  //const width = 1344;
  //const height = 839;
  const radius = Math.min(width, height) / 2 - 20;
  const arcSpan = Math.PI * (spaceDepth / 180); // 200-degree span in radians

  const svg = d3.select("div#graph") // select the graph container
    .append("svg")  // append a svg element
    .attr('id', 'svg-container')
    .attr("width", width) // change width and height of th svg
    .attr("height", height);

  const translateGroupX = width / 2
  const translateGroupY = height - 250;

  // append to global chart variable
  chart = svg

  
  

  const tree = d3.tree() // define tree layout
    .size([arcSpan, radius]) // size of the  Radial layout
    .separation((a, b) => (a.parent === b.parent ? 1 : 1)); // spacing between nodes
    
  // convert data to hierarchy and pass wich field (parents) conatins child nodes
  const root = d3.hierarchy(data, d => d.parents);

  tree(root);
  console.log(JSON.stringify(data))
  


  const levelSpacing = 120; // Set the desired spacing between levels

  root.descendants().forEach(d => {
    d.y = (d.depth * levelSpacing) - (d.depth * (4.5*d.depth)); // Adjust spacing between levels
  });



  // Convert tree coordinates to radial (polar to Cartesian)
  root.descendants().forEach(d => {

    const angle = d.x - arcSpan / 2; // Adjust to center the arc
    const r = d.y;
    d.x = r * Math.sin(angle);
    d.y = -r * Math.cos(angle); // Invert to grow upward

  });
  const chartGroup = svg.append("g") // append a g element to scg
  .attr('id', 'chartGroup')
  .attr("transform", `translate(${translateGroupX}, ${translateGroupY})`); // center the group in the bottom of the svg
  

  chartGroup.append('circle').attr('id', 'refCircle')
    .attr('cx', 0)      // x position of the center of the circle
    .attr('cy', 0)      // y position of the center of the circle
    .attr('r', 5)       // radius of the circle
    .attr('fill', 'transparent'); // fill color of the circle

  /*
chartGroup.append("g")
  .append("path")
  .attr("transform", "translate(0,0)")
  .attr("d", d3.arc()({
    innerRadius: 130,
    outerRadius: 150,
    startAngle: -arcSpan / 3,
    endAngle: arcSpan / 3
  }));

chartGroup.append("g")
  .append("path")
  .attr("transform", "translate(0,0)")
  .attr("d", d3.arc()({
    innerRadius: 280,
    outerRadius: 300,
    startAngle: -arcSpan / 2.5,
    endAngle: arcSpan / 2.5
  }));

chartGroup.append("g")
  .append("path")
  .attr("transform", "translate(0,0)")
  .attr("d", d3.arc()({
    innerRadius: 430,
    outerRadius: 450,
    startAngle: -arcSpan / 2.2,
    endAngle: arcSpan / 2.2
  }));

chartGroup.append("g")
  .append("path")
  .attr("transform", "translate(0,0)")
  .attr("d", d3.arc()({
    innerRadius: 580,
    outerRadius: 600,
    startAngle: -arcSpan / 2,
    endAngle: arcSpan / 2
  }));
*/


  const nodes = chartGroup.selectAll(".node")
    .data(root.descendants())
    .join("g")
    .attr('id', d => {

      if (d.data.id != undefined) {
        return `node-${d.data.id.replaceAll("@", '')}`
        
      }
      else {
        return '';
      }
  
    })
    .attr("class", "node")
    .attr("transform", d => `translate(${d.x}, ${d.y}) scale(${1 - (0.11 * d.depth)})`)
    .on("click.node", (event, d) => { nodeClicked(d) });





 


  nodes.append("foreignObject")
  
    .attr("width", d => { 
      let foreignObjectWidth = 100 - (2 * d.depth)
      return foreignObjectWidth
    
    }) // Adjust width to fit your content
    .attr("height", d => { 
      let foreignObjectHeight = 120 - (2 * d.depth)
      return foreignObjectHeight
    
    }) // Adjust height to fit your content
    .attr("x", -50) // Center the HTML block
    .attr("y", -50) // Adjust y offset to position the HTML block
    .style("cursor", "pointer")
    .style("overflow", "visible")
    .html(d => {

      if (d.data.id == undefined) {

        return ``;
      }

      return foreignObjectHtml(d)

    }


    );


  nodes.select("foreignObject")
    .attr("transform", d => {

      // Convert radians to degrees
      return `rotate(${foreignObjectRotation(d)}, 0, 0)`; // Rotate around the node center
    });



  



  

  const links = chartGroup.selectAll(".link")
    .data(root.links())
    .join("g")
    .attr("class", "link")
    .each(function (d) {
      const group = d3.select(this);  // Select the current group for each link

      // Append the first path
      group.append("path")
        .attr("d", d => {
          
          if (d.source.data.id == undefined || d.target.data.id == undefined) {
            return '';
          }

          
          return get_links(d)


        })
        .attr("fill", "none")
        .attr('stroke-linecap', "round")
        .attr("stroke", d => {
          return getLinkColor(d.target);
        })
        .attr("stroke-width", 1)

      // Append the second path
      group.append("path")
        .attr("d", d => {

          if (d.source.data.id == undefined || d.target.data.id == undefined) {
            return '';
          }

          return get_links(d,t = 0.511)


        })
        .attr("fill", "none")
        .attr('stroke-linecap', "round")
        .attr("stroke", d => {
          return getLinkColor(d.target);
        })
        .attr("stroke-width", 1)
    });






  // Define zoom behavior
  const zoom = d3.zoom()
    .on("zoom", (event) => {
      chartGroup.attr("transform", event.transform); // Apply transformation
    });



  // Apply zoom behavior to the SVG
  svg.call(zoom);

  // Set initial zoom/pan settings to center the chart
  let initialTransform;

  if (chart_status != undefined) {
    initialTransform = d3.zoomIdentity.translate(chart_status.translateX, chart_status.translateY).scale(chart_status.scale);
  }
  else {
    initialTransform = d3.zoomIdentity.translate(translateGroupX, translateGroupY).scale(1);
  }

  svg.call(zoom.transform, initialTransform);

  // Apply the initial transform to the chartGroup
  chartGroup.attr("transform", initialTransform.toString());


  test_all_max_nodes()
  test_max_generation()



  $(document).on("click", "#zoomIn", function () {
    svg.transition().call(zoom.scaleBy, 1.2);
  });

  $(document).on("click", "#zoomOut", function () {
    svg.transition().call(zoom.scaleBy, 0.8);
  });

  $(document).on("click", "#fit", function () {

    const center = d3.zoomIdentity.translate(width / 2, height / 2 + (height / 4))
    svg.call(zoom.transform, center)
  });

  document.addEventListener('keyup', (event) => {
    if (event.key === '+') {
      svg.transition().call(zoom.scaleBy, 1.2);
    }
    if (event.key === '-') {
      svg.transition().call(zoom.scaleBy, 0.8);
    }
  });

  // set chart status


  set_background()

  get_notes()

  get_weapon()

  enable_tools_bar()

}




function foreignObjectHtml(d){
    let imgRotation
      if (treeConfiguration.photos_direction == 'vertical') {
        imgRotation = -foreignObjectRotation(d)
      }
      else {
        imgRotation = 0
      }



      if (treeConfiguration.photos_type == 'round') {
        imgSize = {
          width: '60px',
          height: '60px'
        }
      }
      else {
        imgSize = {
          width: '50px',
          height: '60px'
        }
      }

      style = `padding-top: 1px;
       background-color: transparent;
       color: black;
       width: 100px;
       height: 55px;
       `
      const arc = updateArc(d.depth, 5)
      const path = createPath(d.depth, 5)
      let margin_top
      if (d.depth == 0) {
        margin_top = -60
      }
      else {
        margin_top = -45 - ((d.depth - 1) * 5)
      }

      let personIcon;


      if (d.data.photo !== undefined && d.data.photo !== null) {
        personIcon = "/storage/portraits_fantree/" + d.data.photo;
      }
      else {
        if (d.data.gender === 'M') {
          personIcon = "/storage/placeholder_portraits_fantree/" + treeConfiguration.default_male_image + ".jpg";
        } else {
          personIcon = "/storage/placeholder_portraits_fantree/" + treeConfiguration.default_female_image + ".jpg";
        }
      }


      let boxColor;
      if (d.data.gender === 'M') {
        boxColor = treeConfiguration.male_color
      } else {
        boxColor = treeConfiguration.female_color
      }

      let filter;
      if (treeConfiguration.default_filter == 'none') {
        filter = "none"
      }
      if (treeConfiguration.default_filter == 'grayscale') {
        filter = "grayscale(1)"
      }
      if (treeConfiguration.default_filter == 'invert') {
        filter = "invert(1)"
      }
      if (treeConfiguration.default_filter == 'sepia') {
        filter = "sepia(1)"
      }



      return `
       <div data-personId="${d.data.id}" data-depth="${d.depth}" data-order="${d.data.order}" style="text-align: center; font-family: Arial; font-size: 12px">
           <img id="img-${d.data.id.replaceAll('@', '')}" src="${personIcon}" alt="Photo" style="filter: ${filter}; object-fit: cover;width: ${imgSize.width}; height: ${imgSize.height}; border-radius: 50%; border: 2px solid ${treeConfiguration.band_color};transform: rotate(${imgRotation}deg)">
 
         <div class="" style="${style}">
           <svg id="arc-svg" width="100" height="55" viewBox="-100 -80 200 200" xmlns="http://www.w3.org/2000/svg">
             <path id="curved-rectangle" 
             transform="translate(-170,-50)"
               d="${arc}" 
               fill="${boxColor}" 
               stroke="${boxColor}" 
               stroke-width="2" />

             <g>
             <path id="curve1-${d.data.id}" 
               transform="translate(-170,${margin_top + 40 * 1})"
               d="${path}" 
               fill="transparent" 
               stroke="transparent" 
               stroke-width="2"/>
             <text font-size="20" fill="${treeConfiguration.text_color}" text-anchor="middle">
               <textPath href="#curve1-${d.data.id}" startOffset="50%" font-weight="bold">
                 ${d.data.firstname.toUpperCase()}
               </textPath>
             </text>
             </g>

             <g>
             <path id="curve2-${d.data.id}" 
               transform="translate(-170,${margin_top + 40 * 2})"
               d="${path}" 
               fill="transparent" 
               stroke="transparent" 
               stroke-width="2"/>
             <text font-size="20" fill="${treeConfiguration.text_color}" text-anchor="middle">
               <textPath href="#curve2-${d.data.id}" startOffset="50%">
                 ${d.data.lastname.toUpperCase()}
               </textPath>
             </text>
             </g>

             <g>
             <path id="curve3-${d.data.id}" 
               transform="translate(-170,${margin_top + 40 * 3})"
               d="${path}" 
               fill="transparent" 
               stroke="transparent" 
               stroke-width="2"/>
             <text font-size="20" fill="${treeConfiguration.text_color}" text-anchor="middle">
               <textPath href="#curve3-${d.data.id}" startOffset="50%">
               ${getFullDate(d.data.birth, d.data.death)}
               </textPath>
             </text>
             </g>

           </svg>
         </div>
       </div>
       `;
}


function get_links(d,t = 0.5){
  const child = d.source;
  const parent = d.target;

  const linkTarget = get_target_link(parent, t = t)
  const linkSource = get_source_link(child)

  let curve1X
  let curve1Y
  let curve2X
  let curve2Y

  const offsetBase = 25; // Offset distance for control points
  const depthMinus = (2 * child.depth)
  const offset = 20
  // Calculate the direction vector
  const dx = linkTarget.x - linkSource.x;
  const dy = linkTarget.y - linkSource.y;

  // Calculate the perpendicular vector (rotated by 90 degrees)
  const length = Math.sqrt(dx * dx + dy * dy);
  const perpX = (dy / length) * offset;
  const perpY = (-dx / length) * offset;

  // Control points are offset from the line connecting source and target
  if (parent.data.order == 1) {
    curve1X = linkSource.x - perpX;
    curve1Y = linkSource.y - perpY;
    curve2X = linkTarget.x + perpX;
    curve2Y = linkTarget.y + perpY;
  }
  else {
    curve1X = linkSource.x + perpX;
    curve1Y = linkSource.y + perpY;
    curve2X = linkTarget.x - perpX;
    curve2Y = linkTarget.y - perpY;
  }


  return `M ${linkSource.x} ${linkSource.y} C ${curve1X} ${curve1Y} ${curve2X} ${curve2Y} ${linkTarget.x} ${linkTarget.y}`

}

function get_source_link(d) {

  const node = document.querySelector("#node-" + d.data.id.replaceAll('@', ''))
  const foreignObject = node.querySelector('foreignObject');
  const imgElement = foreignObject.querySelector('img');

  const imgWidth = parseFloat(imgElement.style.width);  // 60px
  const imgHeight = parseFloat(imgElement.style.height); // 60px
  const imgX = parseFloat(foreignObject.getAttribute('x')); // -50
  const imgY = parseFloat(foreignObject.getAttribute('y')); // -50
  let circleCX;
  if (treeConfiguration.photos_type == "round") {
    circleCX = imgX + imgWidth / 2 + 20; // Center of the image horizontally
  }
  else {
    circleCX = imgX + imgWidth / 2 + 25; // Center of the image horizontally
  }

  const circleCY = imgY; // Top of the image

  const circleId = "circleTarget-" + d.data.id.replaceAll('@', '')
  node.innerHTML += `<circle id="${circleId}" cx="${circleCX}" cy="${circleCY}" r="5" fill="transparent" transform="rotate(${foreignObjectRotation(d)}, 0, 0)"/>`;

  const newCircle = getCircleGlobalPosition(circleId)
  return {
    'x': newCircle.x,
    'y': newCircle.y
  };

  //console.log(targetImg)
}

function get_target_link(d, t = 0.5) {

  // get the path from the node
  const circleId = "circle-" + d.data.id.replaceAll('@', '')
  const node = document.querySelector("#node-" + d.data.id.replaceAll('@', '') + " path#curved-rectangle")
  const path = node.getAttribute('d')

  const commands = path.trim().split(/\s+(?=[MLCZ])/);

  const bezierCommandString = commands[3]
  const previousPointString = commands[2]


  /// get translate
  const translate = node.getAttribute('transform')
  const translateX = parseInt(translate.replace('translate', '').replace('(', '').replace(')', '').split(',')[0])
  const translateY = parseInt(translate.replace('translate', '').replace('(', '').replace(')', '').split(',')[1])



  // start calculate coordinate of point
  // Extract P0 coordinates from the string (e.g., "L 292 135")
  let values = previousPointString.trim().slice(2).split(/\s+/).map(Number);
  if (values.length !== 2) {
    throw new Error("Invalid point command");
  }
  const P0 = [values[0], values[1]];
  // Parse the Bézier curve command
  values = bezierCommandString.trim().slice(2).split(/\s+/).map(Number);

  if (values.length !== 6) {
    throw new Error("Invalid cubic Bézier curve command");
  }

  // Extract P1, P2, and P3
  const P1 = [values[0], values[1]];
  const P2 = [values[2], values[3]];
  const P3 = [values[4], values[5]];


  const x = Math.pow(1 - t, 3) * P0[0] +
    3 * Math.pow(1 - t, 2) * t * P1[0] +
    3 * (1 - t) * Math.pow(t, 2) * P2[0] +
    Math.pow(t, 3) * P3[0];

  const y = Math.pow(1 - t, 3) * P0[1] +
    3 * Math.pow(1 - t, 2) * t * P1[1] +
    3 * (1 - t) * Math.pow(t, 2) * P2[1] +
    Math.pow(t, 3) * P3[1];

  const cx = x + translateX
  const cy = y + translateY

  const circle = node.insertAdjacentHTML('afterend', `<circle id="${circleId}" cx="${cx}" cy="${cy}" r="5" fill="transparent" />`);
  const newCircle = getCircleGlobalPosition(circleId)
  //const chartGroupll = document.getElementById('chartGroup')
  //chartGroupll.innerHTML += `<circle id="test-${circleId}" cx="${newCircle["x"]}" cy="${newCircle["y"]}" r="5" fill="blue" />`;

  return {
    'x': newCircle.x,
    'y': newCircle.y
  };
}

const getCircleGlobalPosition = (circleId) => {

  const targetCircle = document.getElementById(circleId).getBoundingClientRect();
  const referenceCircle = document.getElementById('refCircle').getBoundingClientRect();


  const targetRectCenter = {
    x: targetCircle.left + targetCircle.width / 2,
    y: targetCircle.top + targetCircle.height / 2
  };

  const referenceCircleCenter = {
    x: referenceCircle.left + referenceCircle.width / 2,
    y: referenceCircle.top + referenceCircle.height / 2
  };


  const relativePosition = {
    x: targetRectCenter.x - referenceCircleCenter.x,
    y: targetRectCenter.y - referenceCircleCenter.y
  };

  return relativePosition;

}

function getLinkColor(d) {
  if (d.data.gender == 'M') {
    return treeConfiguration.father_link_color;
  }
  else {
    return treeConfiguration.mother_link_color;
  }
}


function getFullDate(birth, death) {


  if (death != null) {
    var { day, month, year } = parseDate(death);
    deathDate = year;
  }
  else {
    deathDate = '';
  }


  if (birth != null) {
    var { day, month, year } = parseDate(birth);
    birthDate = year;
  }
  else {
    birthDate = '';
  }

  if (birthDate == '' && deathDate == '') {
    return ''
  }

  if(birthDate == undefined){
    birthDate = '';
  }

  if(deathDate == undefined){
      deathDate = '';
  }

  return `${birthDate}-${deathDate}`


}

function parseDate(dateStr) {

  const parts = dateStr.split(' ');
  var day, month, year;

  if (parts.length === 1) {
    // Only year is given
    // Use January 1st of that year
    day = null
    month = null
    year = parts[0]

  } else {
    // Full date is given
    const [dayName, monthName, yearName] = parts;
    const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
    const monthIndex = monthNames.indexOf(monthName) + 1;
    day = dayName
    month = monthIndex < 10 ? "0" + monthIndex.toString() : monthIndex.toString()
    year = yearName
  }

  return { day, month, year };

}






function createPath(depth, generation = 7) {
  const startAngle = 80
  const step = startAngle / generation - 1
  if (depth == 0) {
    const angle_top = 0; // from 0 to 0-45

    return `M 0 0 
        C 105 ${angle_top} 225 ${angle_top} 330 0`;
  }
  else {
    const angle_top = 0 - (startAngle - (step * depth - 1)); // from 0 to 0-45

    return `M 0 0 
        C 105 ${angle_top} 225 ${angle_top} 330 0`;
  }

}


function updateArc(depth, generation = 7) {
  const startAngle = 45
  const step = startAngle / generation - 1
  if (depth == 0) {
    const angle_top = 0; // from 0 to 0-45
    const angle_bottom = 135; // from 135 to 135-45


    const right_bottom = 330; // from 330 to 330-15
    const left_bottom = 0; // from 0 to 0+15

    return `M 0 0 
        C 105 ${angle_top} 225 ${angle_top} 330 0 
        L ${right_bottom} 135 
        C 225 ${angle_bottom} 105 ${angle_bottom} ${left_bottom} 135 
        Z`;
  }
  else {
    const angle_top = 0 - (startAngle - (step * depth - 1)); // from 0 to 0-45
    const angle_bottom = 135 - (startAngle - (step * depth - 1)); // from 135 to 135-45


    const right_bottom = 330 - (startAngle - (step * depth - 1)); // from 330 to 330-15
    const left_bottom = 0 + (startAngle - (step * depth - 1)); // from 0 to 0+15

    return `M 0 0 
        C 105 ${angle_top} 225 ${angle_top} 330 0 
        L ${right_bottom} 135 
        C 225 ${angle_bottom} 105 ${angle_bottom} ${left_bottom} 135 
        Z`;
  }

}


function linkRotation(d) {
  let angle;
  if (d.data.order == 0) {
    angle = 0
  }
  else {
    angle = Math.atan2(d.y, d.x) * (180 / Math.PI) + 90
  }

  return angle
}


function foreignObjectRotation(d) {
  let angle;
  if (d.data.order == 0) {
    angle = 0
  }
  else {
    angle = Math.atan2(d.y, d.x) * (180 / Math.PI) + 90
  }

  return angle
}


