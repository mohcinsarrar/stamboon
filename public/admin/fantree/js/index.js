

  const dataSample = {
    "id": 1,
    "order": 0,
    "name": "Person Name",
    "dob": "1900-01-01",
    "photo": "https://randomuser.me/api/portraits/men/76.jpg",
    "translateX": null,
    "translateY": null,
    "parents": [
      {
        "id": 2,
        "order": 1,
        "name": "Parent 1",
        "dob": "1870-01-01",
        "photo": "https://randomuser.me/api/portraits/men/75.jpg",
        "translateX": null,
        "translateY": null,
        "parents": [
          {
            "id": 3,
            "order": 1,
            "name": "Parent 11",
            "dob": "1870-01-01",
            "photo": "https://randomuser.me/api/portraits/men/75.jpg",
            "translateX": null,
            "translateY": null,
            "parents": [
              {
                "id": 4,
                "order": 1,
                "name": "Parent 11",
                "dob": "1870-01-01",
                "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                "translateX": null,
                "translateY": null,
                "parents": [
                  {
                    "id": 5,
                    "order": 1,
                    "name": "Parent 11",
                    "dob": "1870-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  },
                  {
                    "id": 6,
                    "order": 2,
                    "name": "Parent 12",
                    "dob": "1875-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  }
                ]
              },
              {
                "id": 7,
                "order": 2,
                "name": "Parent 12",
                "dob": "1875-01-01",
                "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                "translateX": null,
                "translateY": null,
                "parents": [
                  {
                    "id": 8,
                    "order": 1,
                    "name": "Parent 11",
                    "dob": "1870-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  },
                  {
                    "id": 9,
                    "order": 2,
                    "name": "Parent 12",
                    "dob": "1875-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  }
                ]
              }
            ]
          },
          {
            "id": 10,
            "order": 2,
            "name": "Parent 12",
            "dob": "1875-01-01",
            "photo": "https://randomuser.me/api/portraits/men/74.jpg",
            "translateX": null,
            "translateY": null,
            "parents": [
              {
                "id": 11,
                "order": 1,
                "name": "Parent 11",
                "dob": "1870-01-01",
                "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                "translateX": null,
                "translateY": null,
                "parents": [
                  {
                    "id": 12,
                    "order": 1,
                    "name": "Parent 11",
                    "dob": "1870-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  },
                  {
                    "id": 13,
                    "order": 2,
                    "name": "Parent 12",
                    "dob": "1875-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  }
                ]
              },
              {
                "id": 14,
                "order": 2,
                "name": "Parent 12",
                "dob": "1875-01-01",
                "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                "translateX": null,
                "translateY": null,
                "parents": [
                  {
                    "id": 15,
                    "order": 1,
                    "name": "Parent 11",
                    "dob": "1870-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  },
                  {
                    "id": 16,
                    "order": 2,
                    "name": "Parent 12",
                    "dob": "1875-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "id": 17,
        "order": 2,
        "name": "Parent 2",
        "dob": "1875-01-01",
        "photo": "https://randomuser.me/api/portraits/men/74.jpg",
        "translateX": null,
        "translateY": null,
        "parents": [
          {
            "id": 18,
            "order": 1,
            "name": "Parent 21",
            "dob": "1870-01-01",
            "photo": "https://randomuser.me/api/portraits/men/75.jpg",
            "translateX": null,
            "translateY": null,
            "parents": [
              {
                "id": 19,
                "order": 1,
                "name": "Parent 11",
                "dob": "1870-01-01",
                "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                "translateX": null,
                "translateY": null,
                "parents": [
                  {
                    "id": 20,
                    "order": 1,
                    "name": "Parent 11",
                    "dob": "1870-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  },
                  {
                    "id": 21,
                    "order": 2,
                    "name": "Parent 12",
                    "dob": "1875-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  }
                ]
              },
              {
                "id": 22,
                "order": 2,
                "name": "Parent 12",
                "dob": "1875-01-01",
                "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                "translateX": null,
                "translateY": null,
                "parents": [
                  {
                    "id": 23,
                    "order": 1,
                    "name": "Parent 11",
                    "dob": "1870-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  },
                  {
                    "id": 24,
                    "order": 2,
                    "name": "Parent 12",
                    "dob": "1875-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  }
                ]
              }
            ]
          },
          {
            "id": 25,
            "order": 2,
            "name": "Parent 22",
            "dob": "1875-01-01",
            "photo": "https://randomuser.me/api/portraits/men/74.jpg",
            "translateX": null,
            "translateY": null,
            "parents": [
              {
                "id": 26,
                "order": 1,
                "name": "Parent 11",
                "dob": "1870-01-01",
                "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                "translateX": null,
                "translateY": null,
                "parents": [
                  {
                    "id": 27,
                    "order": 1,
                    "name": "Parent 11",
                    "dob": "1870-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  },
                  {
                    "id": 28,
                    "order": 2,
                    "name": "Parent 12",
                    "dob": "1875-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  }
                ]
              },
              {
                "id": 29,
                "order": 2,
                "name": "Parent 12",
                "dob": "1875-01-01",
                "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                "translateX": null,
                "translateY": null,
                "parents": [
                  {
                    "id": 30,
                    "order": 1,
                    "name": "Parent 11",
                    "dob": "1870-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/75.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  },
                  {
                    "id": 31,
                    "order": 2,
                    "name": "Parent 12",
                    "dob": "1875-01-01",
                    "photo": "https://randomuser.me/api/portraits/men/74.jpg",
                    "translateX": null,
                    "translateY": null,
                    "parents": [
                      // Grandparents
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  }

  function renderChart() {

    const data = familyData

    // select the main container to get width and height
    const mainGraphDiv = d3.select("div#main_graph");
    const spaceDepth = 190
    // Get the width and height of div#graph
    const width = parseInt(mainGraphDiv.style("width")) - 16;
    const height = parseInt(mainGraphDiv.style("height"));
    const radius = Math.min(width, height) / 2 - 20;
    const arcSpan = Math.PI * (spaceDepth / 180); // 200-degree span in radians

    const svg = d3.select("div#graph") // select the graph container
      .append("svg")  // append a svg element
      .attr("width", width) // change width and height of th svg
      .attr("height", height);

    const translateGroupX = width / 2
    const translateGroupY = height - 100;

    const chartGroup = svg.append("g") // append a g element to scg
      .attr("transform", `translate(${translateGroupX}, ${translateGroupY})`); // center the group in the bottom of the svg

    const tree = d3.tree() // define tree layout
      .size([arcSpan, radius]) // size of the  Radial layout
      .separation((a, b) => (a.parent === b.parent ? 1 : 1)); // spacing between nodes

    // convert data to hierarchy and pass wich field (parents) conatins child nodes
    const root = d3.hierarchy(data, d => d.parents);
    tree(root);

    const levelSpacing = 150; // Set the desired spacing between levels

    root.descendants().forEach(d => {
      d.y = d.depth * levelSpacing; // Adjust spacing between levels
    });

    // Convert tree coordinates to radial (polar to Cartesian)
    root.descendants().forEach(d => {

      const angle = d.x - arcSpan / 2; // Adjust to center the arc
      const r = d.y;
      d.x = r * Math.sin(angle);
      d.y = -r * Math.cos(angle); // Invert to grow upward

    });

    chartGroup.append("g")
      .append("path")
      .attr("transform", "translate(0,0)")
      .attr("d", d3.arc()({
        innerRadius: 130,
        outerRadius: 150,
        startAngle: -arcSpan / 3,
        endAngle: arcSpan / 3
      }));

    chartGroup.append("g")
      .append("path")
      .attr("transform", "translate(0,0)")
      .attr("d", d3.arc()({
        innerRadius: 280,
        outerRadius: 300,
        startAngle: -arcSpan / 2.5,
        endAngle: arcSpan / 2.5
      }));

    chartGroup.append("g")
      .append("path")
      .attr("transform", "translate(0,0)")
      .attr("d", d3.arc()({
        innerRadius: 430,
        outerRadius: 450,
        startAngle: -arcSpan / 2.2,
        endAngle: arcSpan / 2.2
      }));

    chartGroup.append("g")
      .append("path")
      .attr("transform", "translate(0,0)")
      .attr("d", d3.arc()({
        innerRadius: 580,
        outerRadius: 600,
        startAngle: -arcSpan / 2,
        endAngle: arcSpan / 2
      }));


    const nodes = chartGroup.selectAll(".node")
      .data(root.descendants())
      .join("g")
      .attr("class", "node")
      .attr("transform", d => `translate(${d.x}, ${d.y})`)
      .on("click.node", (event, node) => {console.log(node)});
      


    // Add foreignObject for HTML content

    nodes.append("foreignObject")
      .attr("width", 100) // Adjust width to fit your content
      .attr("height", 120) // Adjust height to fit your content
      .attr("x", -50) // Center the HTML block
      .attr("y", -50) // Adjust y offset to position the HTML block
      .style("cursor", "pointer")
      .html(d => {

        let IsImgRotation = false
        let imgRotation
        if (IsImgRotation) {
          imgRotation = -foreignObjectRotation(d)
        }
        else {
          imgRotation = 0
        }

        style = `padding-top: 1px;
       background-color: transparent;
       color: black;
       width: 100px;
       height: 55px;`
        const arc = updateArc(d.depth, 5)
        const path = createPath(d.depth, 5)
        let margin_top
        if (d.depth == 0) {
          margin_top = -60
        }
        else {
          margin_top = -45 - ((d.depth - 1) * 5)
        }

        let personIcon;

        if (d.data.photo !== undefined && d.data.photo !== null) {
          personIcon = "/storage/portraits/" + d.data.photo;
        }
        else {
            if (d.data.gender === 'M') {
                personIcon = "/storage/placeholder_portraits/"+treeConfiguration.default_male_image+".jpg";
            } else {
                personIcon = "/storage/placeholder_portraits/"+treeConfiguration.default_female_image+".jpg";
            }
        }


        return `
       <div data-depth="${d.depth}" data-order="${d.data.order}" style="text-align: center; font-family: Arial; font-size: 12px;">
         <img src="${personIcon}" alt="Photo" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #555;transform: rotate(${imgRotation}deg);">
         <div class="" style="${style}">
           <svg id="arc-svg" width="100" height="55" viewBox="-100 -100 200 200" xmlns="http://www.w3.org/2000/svg">
             <path id="curved-rectangle" 
             transform="translate(-170,-55)"
               d="${arc}" 
               fill="lightblue" 
               stroke="blue" 
               stroke-width="2" />

             <g>
             <path id="curve1-${d.data.id}" 
               transform="translate(-170,${margin_top + 40 * 1})"
               d="${path}" 
               fill="transparent" 
               stroke="red" 
               stroke-width="2"/>
             <text font-size="20" fill="black" text-anchor="middle">
               <textPath href="#curve1-${d.data.id}" startOffset="50%">
                 ${d.data.firstname}
               </textPath>
             </text>
             </g>

             <g>
             <path id="curve2-${d.data.id}" 
               transform="translate(-170,${margin_top + 40 * 2})"
               d="${path}" 
               fill="transparent" 
               stroke="red" 
               stroke-width="2"/>
             <text font-size="20" fill="black" text-anchor="middle">
               <textPath href="#curve2-${d.data.id}" startOffset="50%">
                 ${d.data.lastname}
               </textPath>
             </text>
             </g>

             <g>
             <path id="curve3-${d.data.id}" 
               transform="translate(-170,${margin_top + 40 * 3})"
               d="${path}" 
               fill="transparent" 
               stroke="red" 
               stroke-width="2"/>
             <text font-size="20" fill="black" text-anchor="middle">
               <textPath href="#curve3-${d.data.id}" startOffset="50%">
                 ${d.data.death}
               </textPath>
             </text>
             </g>

           </svg>
         </div>
       </div>
       `;

      }


      );


    nodes.select("foreignObject")
      .attr("transform", d => {

        // Convert radians to degrees
        return `rotate(${foreignObjectRotation(d)}, 0, 0)`; // Rotate around the node center
      });



    // Define zoom behavior
    const zoom = d3.zoom()
      .on("zoom", (event) => {
        chartGroup.attr("transform", event.transform); // Apply transformation
      });

    // Apply zoom behavior to the SVG
    svg.call(zoom);

    // Set initial zoom/pan settings to center the chart
    const initialTransform = d3.zoomIdentity.translate(translateGroupX, translateGroupY);
    svg.call(zoom.transform, initialTransform);

    // Apply the initial transform to the chartGroup
    chartGroup.attr("transform", initialTransform.toString());
  }




  function createPath(depth, generation = 7) {
    const startAngle = 80
    const step = startAngle / generation - 1
    if (depth == 0) {
      const angle_top = 0; // from 0 to 0-45

      return `M 0 0 
        C 105 ${angle_top} 225 ${angle_top} 330 0`;
    }
    else {
      const angle_top = 0 - (startAngle - (step * depth - 1)); // from 0 to 0-45

      return `M 0 0 
        C 105 ${angle_top} 225 ${angle_top} 330 0`;
    }

  }


  function updateArc(depth, generation = 7) {
    const startAngle = 45
    const step = startAngle / generation - 1
    if (depth == 0) {
      const angle_top = 0; // from 0 to 0-45
      const angle_bottom = 135; // from 135 to 135-45


      const right_bottom = 330; // from 330 to 330-15
      const left_bottom = 0; // from 0 to 0+15

      return `M 0 0 
        C 105 ${angle_top} 225 ${angle_top} 330 0 
        L ${right_bottom} 135 
        C 225 ${angle_bottom} 105 ${angle_bottom} ${left_bottom} 135 
        Z`;
    }
    else {
      const angle_top = 0 - (startAngle - (step * depth - 1)); // from 0 to 0-45
      const angle_bottom = 135 - (startAngle - (step * depth - 1)); // from 135 to 135-45


      const right_bottom = 330 - (startAngle - (step * depth - 1)); // from 330 to 330-15
      const left_bottom = 0 + (startAngle - (step * depth - 1)); // from 0 to 0+15

      return `M 0 0 
        C 105 ${angle_top} 225 ${angle_top} 330 0 
        L ${right_bottom} 135 
        C 225 ${angle_bottom} 105 ${angle_bottom} ${left_bottom} 135 
        Z`;
    }

  }


  function foreignObjectRotation(d) {
    let angle;
    if (d.data.order == 0) {
      angle = 0
    }
    else {
      angle = Math.atan2(d.y, d.x) * (180 / Math.PI) + 90
    }

    return angle
  }


